// --- 設定周り ---

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"      // データベースの種類はPostgreSQLを使います
  url      = env("DATABASE_URL") // 接続URLは .env ファイルの "DATABASE_URL" から読み込みます
}

// --- データモデル（テーブル）の定義 ---

// ユーザー情報を管理するテーブル
model User {
  id            String    @id @default(cuid()) // ID: ユーザーを一意に識別するID
  name          String                         // 名前: ユーザーの表示名
  phoneNumber   String?   @unique              // 電話番号: 任意項目
  password      String?                        // パスワード: メールアドレスログイン用
  email         String    @unique              // メールアドレス: 必須項目、重複不可
  emailVerified DateTime?                      // メアド確認日時
  image         String?                        // アイコン画像: プロフィール画像のURL
  metadata      Json?                          // メタデータ: その他の情報
  
  // --- リレーション ---
  accounts      Account[]                      // 1人のユーザーは複数の「アカウント連携」を持つ
  sessions      Session[]                      // 1人のユーザーは複数の「ログインセッション」を持つ
  messages      Message[]                      // 1人のユーザーはたくさんの「メッセージ」を送る
  threads       Thread[]                       // 1人のユーザーはたくさんの「スレッド」を持つ
  documents     Document[]                     // 1人のユーザーはたくさんの「ドキュメント」を登録する
  feedbacks     Feedback[]                     // 1人のユーザーはたくさんの「フィードバック」を送る
  subscription  UserSubscription?              // サブスクリプション情報
  
  createdAt     DateTime  @default(now())      // 作成日時
  updatedAt     DateTime  @updatedAt           // 更新日時
}

// 登録された知識（ドキュメント）の目次テーブル
model Document {
  id         String   @id @default(cuid()) // ID
  userId     String                        // 誰のドキュメントか
  title      String                        // タイトル: ファイル名など
  content    String?                       // 本文: 全文検索・ロングコンテキスト用
  summary    String?                       // 要約: 一覧表示・概要検索用
  type       String   @default("knowledge") // 種類: "knowledge" (ファイル) or "note" (ノート)
  tags       String[] @default([])         // タグ: 複数カテゴリ対応
  source     String                        // 情報源: "google-drive" や "manual",voicememo
  mimeType   String?                       // ファイル形式: "application/pdf", "image/jpeg" など
  externalId String?                       // Pinecone（ベクトルDB）と PostgreSQL（リレーショナルDB）を紐付けるための共通ID
  fileCreatedAt DateTime?                  // ファイル自体の作成日時（または最終更新日時）
  createdAt  DateTime @default(now())      // 作成日時
  
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade) // リレーション設定
}

// チャットの履歴テーブル
// チャットの履歴テーブル
model Message {
  id        String   @id @default(cuid()) // ID
  content   String                        // 内容
  role      String                        // 役割: "user" か "assistant"
  category  String?  @default("その他")   // カテゴリ
  userId    String                        // 誰のメッセージか
  threadId  String?                       // スレッドID (履歴機能用)
  createdAt DateTime @default(now())      // 送信日時

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade) // リレーション設定
  thread    Thread?  @relation(fields: [threadId], references: [id], onDelete: Cascade) // スレッドとのリレーション
}

// チャットスレッド（履歴のまとまり）
model Thread {
  id        String    @id @default(cuid())
  userId    String
  title     String    @default("New Chat") // スレッドのタイトル
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt           // 最終更新日時（並び替え用）

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages  Message[]
}

// 外部アカウント連携（Google, LINEなど）の鍵束テーブル
model Account {
  id                 String  @id @default(cuid()) // ID
  userId             String                       // 誰の連携情報か
  type               String                       // タイプ: "oauth"
  provider           String                       // プロバイダ名: "google", "line"
  providerAccountId  String                       // プロバイダ側のID
  refresh_token      String?  @db.Text            // リフレッシュトークン
  access_token       String?  @db.Text            // アクセストークン
  expires_at         Int?                         // 有効期限
  token_type         String?                      // トークンタイプ
  scope              String?                      // スコープ
  id_token           String?  @db.Text            // IDトークン
  session_state      String?                      // セッション状態

  user User @relation(fields: [userId], references: [id], onDelete: Cascade) // リレーション設定

  @@unique([provider, providerAccountId]) // 複合ユニーク制約
}

// ログイン中の状態（セッション）管理テーブル
model Session {
  id           String   @id @default(cuid()) // ID
  sessionToken String   @unique              // セッショントークン
  userId       String                        // 誰がログインしているか
  expires      DateTime                      // 有効期限
  
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade) // リレーション設定
}

// メール認証用の一時トークン
model VerificationToken {
  identifier String   // 識別子
  token      String   @unique // トークン
  expires    DateTime // 有効期限

  @@unique([identifier, token]) // 複合ユニーク制約
}

// ユーザーからのフィードバック
model Feedback {
  id        String   @id @default(cuid()) // ID
  userId    String                        // 送信者ID
  content   String                        // 内容
  createdAt DateTime @default(now())      // 送信日時

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// --- マネタイズ関連 (サブスク & チケット) ---

enum Plan {
  FREE        // 梅
  STANDARD    // 竹
  PREMIUM     // 松
}

model UserSubscription {
  id            String    @id @default(cuid()) // ID
  userId        String    @unique              // ユーザーID
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // --- 基本プラン設定 ---
  plan          Plan      @default(FREE)       // 現在のプラン (FREE, STANDARD, PREMIUM)
  
  // Stripe連携 (将来用)
  stripeCustomerId       String?   @unique     // Stripeの顧客ID (cus_...)
  stripeSubscriptionId   String?   @unique     // StripeのサブスクリプションID (sub_...)
  currentPeriodEnd       DateTime?             // サブスク有効期限 (この日時まで有効)

  // --- 制限管理 (Quota Management) ---

  // 1. チャット制限 (汎用カウンタ)
  // Free: 上限10回 / "lastChatResetAt" から2時間経てば 0 にリセット
  // Standard: 上限100回 / 日付が変われば 0 にリセット
  // Premium: 上限200回 / 日付が変われば 0 にリセット
  dailyChatCount    Int       @default(0)       // 現在の送信数 (加算式)
  lastChatResetAt   DateTime  @default(now())   // 最後にリセットした日時 (旧: lastChatDate)

  // 2. 音声回数制限 (Free専用)
  // "Note録音 + Upload = 1日5回まで"
  // Standard/Premium は無視(無制限)
  dailyVoiceCount   Int       @default(0)       // 本日の音声処理回数
  lastVoiceDate     DateTime  @default(now())   // 日付リセット判定用

  // 3. 音声時間制限 (Standard/Premium専用)
  // "Note録音 + Upload = 月間 1800分 or 6000分"
  monthlyVoiceMinutes Int     @default(0)       // 今月の音声処理時間 (分)
  lastVoiceResetDate  DateTime  @default(now()) // 月次リセット判定用

  // 4. 追加購入枠 (チケット残高)
  // 300円課金で +270分 されるチャージ残高 (売価は90分100円)
  purchasedVoiceBalance Int   @default(0)       // 追加購入した音声処理時間 (分)

  updatedAt     DateTime  @updatedAt            // 更新日時
}
