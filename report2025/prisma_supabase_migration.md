# Prisma, Supabase, PostgreSQL と マイグレーションの完全解説

## 1. 登場人物の整理：誰が何をしているの？

Web開発におけるデータベース周りの用語はややこしいですが、**「図書館」**に例えるとスッキリ理解できます。

### 📚 PostgreSQL (ポストグレス・キューエル)
*   **役割**: **「本棚（データベース本体）」**
*   **説明**: 実際にデータ（本）を保存しておく場所です。世界中で使われている非常に高性能な「本棚」の規格です。

### ⚡ Supabase (シュパベース)
*   **役割**: **「図書館（ホスティングサービス）」**
*   **説明**: PostgreSQL（本棚）をクラウド上で管理・提供してくれるサービスです。
    *   本棚を置く場所（サーバー）を貸してくれる。
    *   セキュリティ（入館管理）やバックアップ（修復）もやってくれる。
    *   「PostgreSQLを便利に使えるようにした豪華な図書館」です。

### 💎 Prisma (プリズマ)
*   **役割**: **「司書・翻訳機（ORM）」**
*   **説明**: プログラム（TypeScriptなど）とデータベース（SQL）の間に入って、言葉を翻訳してくれる存在です。
    *   あなたは「司書さん、この条件の本を探して」とTypeScriptで頼むだけ。
    *   司書（Prisma）がそれをSQL（データベース語）に翻訳して、本棚から取ってきてくれます。

---

## 2. マイグレーション (Migration) とは？

マイグレーションとは、**「データベースの設計図の履歴管理」**のことです。

### なぜ必要なの？
アプリを作っていると、保存したいデータは変わっていきます。
*   最初は「ユーザー名」だけでよかった。
*   後から「年齢」も保存したくなった。
*   さらに「プロフィール画像」も必要になった。

これを、本棚（データベース）に直接トンカチで工事をして変更してしまうと…
*   **「いつ、誰が、どう変えたか」**がわからなくなる。
*   チームメンバーのパソコンにある本棚と形が合わなくなる。
*   本番環境の本棚を壊してしまうリスクがある。

### マイグレーションの仕組み
マイグレーションは、**「改装工事の指示書」**を順番に記録していく仕組みです。

1.  「年齢を入れる棚を追加する」という指示書（マイグレーションファイル）を作る。
2.  その指示書通りに工事を実行する。
3.  「この本棚は、指示書No.2まで工事済み」という記録を残す。

こうすれば、誰がいつ工事しても、必ず同じ形の本棚が出来上がります。

---

## 3. Prismaでのマイグレーション実践

Prismaでは、以下のコマンドでこの「工事」を管理します。

### ① `schema.prisma` (設計図)
まず、ここに変更を書きます。
```prisma
model User {
  id    Int    @id @default(autoincrement())
  name  String
  age   Int?   // ← 新しく追加！
}
```

### ② `npx prisma migrate dev` (開発環境用)
**「設計図を元に、新しい指示書を作って、手元の本棚を工事する」**コマンドです。

1.  `schema.prisma` を見て、前回との差分を見つける。
2.  `migrations/20251202_add_age/migration.sql` のような**SQLファイル（指示書）**を自動生成する。
3.  そのSQLを実行して、あなたのPCのデータベースを変更する。
4.  Prismaクライアント（司書さんの辞書）も更新する。

**いつ使う？**: 開発中、`schema.prisma` を書き換えたら毎回使います。

### ③ `npx prisma migrate deploy` (本番環境用)
**「手元で作った指示書を、本番の本棚に適用する」**コマンドです。

1.  `migrations` フォルダにあるSQLファイル（指示書）を見る。
2.  本番データベースがどこまで工事済みか確認する。
3.  まだやっていない工事（SQL）だけを実行する。

**重要**: 本番環境では、勝手に新しい指示書を作ってはいけません。**「開発環境で作られた指示書を、ただ実行するだけ」**にする必要があります。だから `dev` ではなく `deploy` を使います。

---

## まとめ

*   **PostgreSQL**: 本棚（データ保存場所）
*   **Supabase**: 図書館（本棚の管理者）
*   **Prisma**: 司書（データの出し入れ係）
*   **マイグレーション**: 本棚の改装工事の履歴書
    *   `migrate dev`: 指示書を作って、手元で工事する。
    *   `migrate deploy`: 作られた指示書を、本番で実行する。
