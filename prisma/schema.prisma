// --- 設定周り ---

generator client {
  provider = "prisma-client-js" // JavaScript/TypeScript向けのものを使います
}

datasource db {
  provider = "postgresql"      // データベースの種類はPostgreSQLを使います
  url      = env("DATABASE_URL") // 接続URLは .env ファイルの "DATABASE_URL" から読み込みます
}

// --- データモデル（テーブル）の定義 ---

// ユーザー情報を管理するテーブル
model User {
  id            String    @id @default(cuid()) // ID: ユーザーを一意に識別するID
  name          String                         // 名前: ユーザーの表示名
  phoneNumber   String?   @unique              // 電話番号: 任意項目
  password      String?                        // パスワード: メールアドレスログイン用
  email         String    @unique              // メールアドレス: 必須項目、重複不可
  emailVerified DateTime?                      // メアド確認日時
  image         String?                        // アイコン画像: プロフィール画像のURL
  metadata      Json?                          // メタデータ: その他の情報
  
  // --- リレーション ---
  accounts      Account[]                      // 1人のユーザーは複数の「アカウント連携」を持つ
  sessions      Session[]                      // 1人のユーザーは複数の「ログインセッション」を持つ
  messages      Message[]                      // 1人のユーザーはたくさんの「メッセージ」を送る
  documents     Document[]                     // 1人のユーザーはたくさんの「ドキュメント」を登録する
  feedbacks     Feedback[]                     // 1人のユーザーはたくさんの「フィードバック」を送る
  
  createdAt     DateTime  @default(now())      // 作成日時
  updatedAt     DateTime  @updatedAt           // 更新日時
}

// 登録された知識（ドキュメント）の目次テーブル
model Document {
  id         String   @id @default(cuid()) // ID
  userId     String                        // 誰のドキュメントか
  title      String                        // タイトル: ファイル名など
  source     String                        // 情報源: "google-drive" や "manual"
  externalId String?                       // 外部ID: GoogleドライブのファイルIDなど
  createdAt  DateTime @default(now())      // 作成日時
  
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade) // リレーション設定
}

// チャットの履歴テーブル
model Message {
  id        String   @id @default(cuid()) // ID
  content   String                        // 内容
  role      String                        // 役割: "user" か "assistant"
  category  String?  @default("その他")   // カテゴリ
  userId    String                        // 誰のメッセージか
  createdAt DateTime @default(now())      // 送信日時

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade) // リレーション設定
}

// 外部アカウント連携（Google, LINEなど）の鍵束テーブル
model Account {
  id                 String  @id @default(cuid()) // ID
  userId             String                       // 誰の連携情報か
  type               String                       // タイプ: "oauth"
  provider           String                       // プロバイダ名: "google", "line"
  providerAccountId  String                       // プロバイダ側のID
  refresh_token      String?  @db.Text            // リフレッシュトークン
  access_token       String?  @db.Text            // アクセストークン
  expires_at         Int?                         // 有効期限
  token_type         String?                      // トークンタイプ
  scope              String?                      // スコープ
  id_token           String?  @db.Text            // IDトークン
  session_state      String?                      // セッション状態

  user User @relation(fields: [userId], references: [id], onDelete: Cascade) // リレーション設定

  @@unique([provider, providerAccountId]) // 複合ユニーク制約
}

// ログイン中の状態（セッション）管理テーブル
model Session {
  id           String   @id @default(cuid()) // ID
  sessionToken String   @unique              // セッショントークン
  userId       String                        // 誰がログインしているか
  expires      DateTime                      // 有効期限
  
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade) // リレーション設定
}

// メール認証用の一時トークン
model VerificationToken {
  identifier String   // 識別子
  token      String   @unique // トークン
  expires    DateTime // 有効期限

  @@unique([identifier, token]) // 複合ユニーク制約
}

// ユーザーからのフィードバック
model Feedback {
  id        String   @id @default(cuid()) // ID
  userId    String                        // 送信者ID
  content   String                        // 内容
  createdAt DateTime @default(now())      // 送信日時

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}
