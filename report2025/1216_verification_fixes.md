# 検証・修正レポート (2025/12/16)

## 検証ステータス: 進行中

本日の検証作業（ステップ1, 2）において実施した修正と、判明した課題をまとめます。

### 1. レガシーコード（旧認証システム）の完全撤去
Firebase Authenticationへの完全移行に伴い、不要となった旧来のパスワード認証ロジックを削除しました。

- **削除**: `app/actions/register.ts` (Next.jsサーバーサイドでのパスワードハッシュ化・登録処理)
- **削除**: `bcryptjs` ライブラリ (依存関係から削除)
- **修正**: `app/api/user/profile/route.ts` (パスワード・メールアドレス更新ロジックを削除し、Firebase側の管理に統一)
- **修正**: `app/register/page.tsx` (旧登録フォームを削除し、ログインへの誘導のみに変更)

これにより、認証フローがシンプルになり、セキュリティリスク（自前でのパスワード管理）が解消されました。

### 2. Google Drive 連携仕様の修正と確認
Google Driveインポート機能において、NextAuth時代の「DBにトークンを保存する方式」から、Firebase時代の「クライアントで都度トークンを取得する方式」への移行を確認・修正しました。

- **修正**: OAuthスコープを `drive.readonly` (全権限) から `drive.file` (選択ファイルのみ) に変更。
  - セキュリティ向上（必要最小限の権限）
  - ユーザーへの警告画面の低減
- **確認**: インポート処理 (`/api/drive/import`) がフロントエンドから渡されたトークン (`x-google-access-token`) を正しく使用していることを確認。
- **削除予定**: 未使用となった `/api/drive/list` エンドポイント。

### 3. トラブルシューティング（接続エラー関連）
「Google Driveに接続」ボタンが反応しない、またはポップアップがすぐ消える現象について、原因を特定しました。

- **原因1**: **Authorized Domain** (承認済みドメイン) の不一致
  - Firebaseは `localhost` を許可していますが、 `0.0.0.0` (IPアドレス等) はデフォルトで許可していません。
  - **対策**: ブラウザで `http://localhost:3000` にアクセスすることを徹底。
- **原因2**: **LINEログインのコールバック設定**
  - LINEログイン後にIPアドレス (`0.0.0.0` 等) にリダイレクトされる場合、`.env` の `NEXT_PUBLIC_LINE_CALLBACK_URL` 設定を見直す必要がある。
- **原因3**: **Google Drive APIキー設定の確認**
  - `NEXT_PUBLIC_GOOGLE_CLIENT_ID` および `API_KEY` が不足している場合のデバッグ用ログを追加。

### 今後のステップ
- **ステップ3: セキュリティ詳細検証** (APIルートの保護漏れがないかチェック)
- **完了確認**: Docker再起動後、Google Driveインポートが正常に動作することを確認して完了。
