# 2025-12-02: Hallucination Prevention & Safe Deployment

## 1. ハルシネーション防止策の強化 (Hallucination Prevention)

AIが事実に基づかない情報を生成（ハルシネーション）するのを防ぐため、システムプロンプトと開発ルールを大幅に強化しました。

### 1.1. システムプロンプトの刷新
*   **ファイル分離**: `backend/main.py` にハードコードされていたプロンプトを `backend/prompts.py` に分離し、管理しやすくしました。
*   **「私の記憶データ」の明確化**:
    *   RAGで取得したデータを「私の記憶データ（Context）」と定義。
    *   「データによると」ではなく「私の記憶データによると」と発言させることで、情報の出所（内部知識 vs 一般知識）を明確に区別させました。
*   **厳格な行動指針**:
    *   **自己検証**: 回答前に「事実は？ソースは？」を自問自答させるプロセスを追加。
    *   **禁止事項**: 架空の物語や推測による断定を禁止。
    *   **出典明記**: 可能な限りファイル名を引用するよう指示。
*   **エンゲージメントと視認性**:
    *   冒頭/結びに短く学習意欲を高める言葉（労いなど）を追加。
    *   重要語句の**太字化**、箇条書きの強制。
    *   「次の一手（おすすめの質問）」の提案機能。

### 1.2. 開発ルールの更新 (.cursorrules)
*   AIアシスタント（私）自身の行動指針として、上記と同様のハルシネーション防止ルールを `.cursorrules` に追加しました。

## 2. インフラ・デプロイの最適化 (Infrastructure & Deployment)

### 2.1. Cloud Build の高速化
*   **並列ビルド**: フロントエンドとバックエンドのビルドを並列化（`waitFor: ['-']`）。
*   **キャッシュ利用**: `--cache-from` を使用し、変更がないレイヤー（npm install等）を再利用することでビルド時間を短縮。
*   **タイムアウト対策**: デフォルトの60分で十分な速度が出るように改善（一時的に延長したが元に戻した）。

### 2.2. DBマイグレーション運用への移行
*   **課題**: `db push`（強制同期）運用により、本番DBとマイグレーション履歴の不整合（Drift）が発生。また、インタラクティブな確認画面でビルドがタイムアウトする問題が発覚。
*   **対策**:
    *   **運用変更**: `db push` から、安全な `prisma migrate deploy` 運用へ切り替え。
    *   **リセット**: 不整合を解消するため、ローカルおよび本番DBを一度 `migrate reset --force` でリセットし、正規のマイグレーション履歴（`init`）を作成。
    *   **安全性**: 今後はマイグレーションファイルに基づく安全なスキーマ変更が可能になります。

## 3. 次のアクション
*   本番デプロイ（リセット実行）の完了確認。
*   `cloudbuild.yaml` のコマンドを `migrate reset` から `migrate deploy` に戻す（**重要**）。
