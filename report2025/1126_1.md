# 開発レポート: 2025/11/26 (Part 1)

## 1. LINEログインとID連携（メアド作戦）

### 🎯 なぜやったか？ (Why)
*   **課題**: 電話番号で登録したユーザーが、後からLINEでログインすると「別の新しいユーザー」として作成されてしまい、アカウントが重複する問題があった。
*   **目的**: 「電話番号登録」と「LINEログイン」を、**メールアドレス** を共通の鍵として紐付け、同一人物として扱えるようにするため。

### 🛠️ どうやってやったか？ (How)
1.  **DBスキーマ変更**:
    *   `User` テーブルの `email` を「任意」から **「必須 (String @unique)」** に変更。
2.  **登録フォームの改修**:
    *   新規登録画面に「メールアドレス」入力欄を追加。
    *   登録時にメールアドレスもDBに保存するようにServer Actionを修正。
3.  **認証ロジックの修正 (`auth.ts`)**:
    *   `PrismaAdapter` を導入し、NextAuthとDBを密結合させた。
    *   LINEプロバイダーの設定に `scope: "openid profile email"` を追加し、LINEからメアドを取得できるようにした。
    *   `allowDangerousEmailAccountLinking: true` を設定し、同じメアドなら自動的にアカウントを統合するようにした。

### ✅ 何のために？ (Result)
*   ユーザーが「電話番号」で登録しても、「LINE」でログインしても、メールアドレスが同じなら **「同じアカウント」** にログインできるようになりました。

---

## 2. Vercelへのデプロイとエラー修正

### 🎯 なぜやったか？ (Why)
*   **課題**: LINEログインは `localhost` (http) では動作確認が難しく、本番環境 (https) が必要だった。また、LINE側のステータスが「開発中」だと自分しかログインできないため、公開環境が必要だった。
*   **目的**: アプリをインターネット上に公開し、誰でもアクセス・ログインできるようにするため。

### 🛠️ どうやってやったか？ (How)
1.  **Vercelプロジェクト作成**:
    *   GitHubリポジトリと連携してデプロイ。
2.  **クラウドDB (Vercel Postgres) の導入**:
    *   Vercel上ではDockerが使えないため、クラウド上のPostgresを用意し、接続設定 (`DATABASE_URL`) を行った。
3.  **500エラー (Middleware Error) の修正**:
    *   **原因**: Vercelの仕様上、ルートにある `api/` ディレクトリが「Serverless Functions」として認識され、Next.jsのAPIルートと競合・誤動作していた。また、Honoサーバーが独立して動こうとしていた。
    *   **対策**: **Hono（バックエンド）をNext.jsのAPIルート (`app/api/[[...route]]/route.ts`) に完全統合した。**
        *   `vercel.json` とルートの `api/` フォルダを削除。
        *   `src/index.ts` を修正し、`app.basePath("/api")` を設定。
        *   `next.config.mjs` の `rewrites` 設定（転送設定）を削除。

### ✅ 何のために？ (Result)
*   アプリがVercel上で正常に動作するようになりました。
*   バックエンド（Hono）とフロントエンド（Next.js）が一体化し、構成がシンプルになりました。
