# Dockerの軽量化（最適化）について

## 1. なぜ軽量化するのか？

Dockerイメージを小さく（軽量化）することには、大きなメリットがあります。

1.  **ビルド・デプロイが速くなる**: ファイルサイズが小さいと、アップロードやダウンロードの時間が短縮されます。
2.  **コスト削減**: クラウド（Google Cloud Runなど）では、保存容量や転送量にお金がかかる場合があります。
3.  **セキュリティ向上**: 不要なツールやファイルが入っていないため、攻撃されるリスクが減ります。

---

## 2. 主な軽量化テクニック

### ① マルチステージビルド (Multi-stage Build)

これが最も効果的な方法です。
**「ビルド（料理を作る）環境」**と**「実行（料理を出す）環境」**を分ける考え方です。

**例え話：**
カレーを作るとします。
*   **準備:** まな板、包丁、皮むき器、野菜の皮、肉のトレーなどが必要です。
*   **提供:** お皿に入ったカレーとスプーンだけでOKです。

完成してお客さんに出すときに、まな板や野菜の皮（ビルドツールやソースコード）は不要ですよね？
マルチステージビルドは、**「完成したカレーだけを新しいお皿（最終イメージ）に移し替える」**技術です。

**Dockerfileのイメージ:**

```dockerfile
# ステージ1: ビルド環境（まな板や包丁がある場所）
FROM node:18 AS builder
WORKDIR /app
COPY . .
RUN npm install
RUN npm run build  # ここでアプリをビルド！

# ステージ2: 実行環境（お客さんに出すお皿）
# ここで軽量なOSを選びます
FROM node:18-alpine AS runner
WORKDIR /app

# ステージ1で作った「完成品」だけをコピーしてくる
COPY --from=builder /app/.next ./.next
COPY --from=builder /app/package.json ./package.json
# ...必要なものだけコピー

CMD ["npm", "start"]
```

### ② 軽量ベースイメージの使用 (Alpine Linux)

Dockerイメージの土台（OS）を軽いものにします。
よく使われるのが **Alpine Linux (アルパイン・リナックス)** です。

*   **通常のLinux (Debian/Ubuntuなど)**: 多機能で便利だが重い（数百MB）。
*   **Alpine Linux**: 必要最小限の機能しかないが、超軽量（数MB〜数十MB）。

`FROM node:18` ではなく `FROM node:18-alpine` を使うだけで、劇的にサイズが減ります。

### ③ .dockerignore の活用

これは `.gitignore` のDocker版です。
「Dockerイメージに入れたくないファイル」を指定します。

**これがないとどうなる？**
`node_modules`（手元のPCにある大量のライブラリ）や、`.git`（履歴データ）、`README.md` など、実行に不要なファイルまで全てDockerの中にコピーされてしまい、ビルドが遅くなり、サイズが巨大化します。

**良い .dockerignore の例:**
```text
node_modules
.git
.env        # セキュリティのため、環境変数は入れない！
README.md
Dockerfile
```

---

## まとめ

Dockerの軽量化とは、**「本番で動くために本当に必要なものだけを選んで、小さな箱に詰めること」**です。

1.  **マルチステージビルド**で、ビルド道具を捨てる。
2.  **Alpine**で、箱（OS）自体を軽くする。
3.  **.dockerignore**で、ゴミ（不要ファイル）を入れない。

これらを組み合わせることで、数百MB〜数GBあったイメージが、数十MB〜数百MBまで小さくなります！
