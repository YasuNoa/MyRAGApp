// --- 設定周り ---

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x", "debian-openssl-3.0.x"]
}

generator client_py {
  provider             = "prisma-client-py"
  interface            = "asyncio"
  recursive_type_depth = 5
}



datasource db {
  provider = "postgresql"      // データベースの種類はPostgreSQLを使います
  url      = env("DATABASE_URL") // 接続URLは .env ファイルの "DATABASE_URL" から読み込みます
}

// --- データモデル（テーブル）の定義 ---

// ユーザー情報を管理するテーブル
// アプリケーションの利用者全員がここに登録されます。
model User {
  id            String    @id @default(cuid()) // ユーザーID: システム内部で使う一意のID (CUID形式)
  name          String                         // ユーザー名: 表示用 (例: "山田 太郎")
  phoneNumber   String?   @unique              // 電話番号: 重複不可 (オプショナル)
  password      String?                        // パスワード: メール/パスワードログイン用 (Firebase認証なら未使用の可能性あり)
  email         String    @unique              // メールアドレス: 必須・重複不可 (ユーザー識別の要)
  emailVerified DateTime?                      // メールアドレス確認日時 (確認済みかどうかのフラグ)
  image         String?                        // プロフィール画像URL: アバター表示用
  metadata      Json?                          // その他のメタデータ: 将来的な拡張用 (自由形式のJSON)
  
  // --- リレーション（他のテーブルとの繋がり） ---
  accounts      Account[]                      // 連携アカウント: Google, LINEなどの外部ログイン情報
  messages      Message[]                      // 送信メッセージ履歴: ユーザーが送ったチャット
  threads       Thread[]                       // チャットスレッド: 過去の会話のまとまり
  courses       Course[]                       // コース一覧: ユーザーが作成した科目フォルダ
  documents     Document[]                     // 登録ドキュメント: ユーザーがアップロードした知識データ
  feedbacks     Feedback[]                     // フィードバック: 運営への意見・要望
  subscription  UserSubscription?              // サブスクリプション: プラン契約情報 (1対1)
  sentReferrals Referral[]    @relation("SentReferrals")      // 自分が紹介した履歴 (友達招待機能)
  receivedReferral Referral?  @relation("ReceivedReferral")   // 自分を紹介してくれた人の情報
  
  createdAt     DateTime  @default(now())      // アカウント作成日時
  updatedAt     DateTime  @updatedAt           // アカウント情報最終更新日時
}

// 科目（コース）を管理するテーブル
// ユーザーは全ての資料を科目単位でフォルダ管理します。
model Course {
  id        String   @id @default(cuid()) // コースID
  userId    String                        // 所有者のユーザーID
  title     String                        // 科目名: "数学", "歴史" など
  color     String   @default("blue")     // フォルダ色: UI表示用 (blue, red, green, etc.)
  icon      String?                       // アイコン: 絵文字など (オプション)
  createdAt DateTime @default(now())      // 作成日時
  updatedAt DateTime @updatedAt           // 更新日時

  // リレーション
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  documents Document[]                    // この科目に含まれる資料
  exams     Exam[]                        // この科目から作られた試験
}

// 登録された知識（ドキュメント）を管理するテーブル
// ユーザーがアップロードしたPDFや録音データなどがここに保存されます。
model Document {
  id         String   @id @default(cuid()) // ドキュメントID
  userId     String                        // 所有者のユーザーID (Userテーブルのidと紐付け)
  courseId   String?                       // コースID: 所属する科目 (マイグレーション中はOptional、後で必須化を検討)
  title      String                        // タイトル: ファイル名やユーザーが付けた名前
  content    String?                       // 本文テキスト: 全文検索やAIの参照用 (OCR結果や文字起こし)
  summary    String?                       // 要約テキスト: 一覧画面での表示や概要検索用
  type       String   @default("knowledge") // データの種類: "knowledge" (ファイル), "note" (音声メモ) など
  tags       String[] @default([])         // タグ: "授業", "英語" などのカテゴリ分け (配列)
  source     String                        // データ情報源: "google-drive" (ドライブ連携), "manual" (手動), "voicememo" (録音)
  mimeType   String?                       // ファイル形式: "application/pdf", "audio/mpeg" など
  
  // 外部サービスとの連携用ID (重複防止・特定用)
  googleDriveId String?   @unique        // Google Drive上のファイルID
  lineMessageId String?   @unique        // LINEのメッセージID (LINEから送られたファイルの場合)
  
  fileCreatedAt DateTime?                  // ファイル自体の作成日時 (アップロード日時とは別に、ファイルの更新日を保持)
  createdAt  DateTime @default(now())      // 登録日時 (システムへのアップロード日)
  deletedAt  DateTime?                     // 削除日時 (ゴミ箱機能用: nullなら有効、入っていればゴミ箱)
  
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade) // ユーザーが削除されたらドキュメントも削除
  course     Course?  @relation(fields: [courseId], references: [id], onDelete: SetNull) // 科目リレーション
  chunks     DocumentChunk[] // Vector chunks for this document
}

// 試験（Exam）全体を管理するテーブル
model Exam {
  id        String    @id @default(cuid())
  courseId  String
  title     String    // 試験タイトル (例: "中間テスト対策")
  createdAt DateTime  @default(now())

  course    Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  questions Question[]
}

// 試験の各問題（Question）を管理するテーブル
model Question {
  id        String    @id @default(cuid())
  examId    String
  type      String    // 問題タイプ: "MULTIPLE_CHOICE", "FILL_IN", "ESSAY"
  text      String    // 問題文
  order     Int       // 出題順
  
  // 柔軟なデータ構造（選択肢、正解、解説など）
  // 4択: { "options": ["A", "B", "C", "D"], "answer": "A", "explanation": "..." }
  // 穴埋め: { "answer": "徳川家康", "explanation": "..." }
  data      Json
  
  exam      Exam      @relation(fields: [examId], references: [id], onDelete: Cascade)
}

// チャットのメッセージ履歴を管理するテーブル
// ユーザーとAIの個別の発言がレコードとして保存されます。
model Message {
  id        String   @id @default(cuid()) // メッセージID
  content   String                        // 発言内容: テキスト
  role      String                        // 発言者の役割: "user" (ユーザー), "assistant" (AI)
  category  String?  @default("その他")   // カテゴリ: 会話の内容分類 (自動タグ付け用)
  userId    String                        // 発言したユーザーのID
  threadId  String?                       // 所属するスレッドのID (どの会話の一部か)
  createdAt DateTime @default(now())      // 送信日時
  
  // リレーション
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade) // ユーザー削除で履歴も削除
  thread    Thread?  @relation(fields: [threadId], references: [id], onDelete: Cascade) // スレッド削除でメッセージも削除
}

// チャットスレッド（会話のまとまり）を管理するテーブル
// 履歴画面で「昨日の会話」「英語の勉強」のように表示される単位です。
model Thread {
  id        String    @id @default(cuid()) // スレッドID
  userId    String                         // 所有者のユーザーID
  title     String    @default("New Chat") // スレッドタイトル: 最初の会話から自動生成などが可能
  createdAt DateTime  @default(now())      // スレッド作成日時
  updatedAt DateTime  @updatedAt           // 最終更新日時: 会話履歴の並び替えに使用
  
  // リレーション
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages  Message[]                    // このスレッドに含まれるメッセージ一覧
}

// 外部アカウント連携（Google, LINEなど）の認証情報を管理するテーブル
// Firebase AuthenticationとユーザーIDを紐付けるための重要なテーブルです。
model Account {
  id                 String   @id @default(cuid()) // ID
  userId             String                        // 紐付くユーザーのID
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  provider           String // プロバイダ名: "firebase" (基本), "google", "line" など
  providerAccountId  String // プロバイダ側のID: FirebaseのUID (User ID) などが一意のキーになります
  
  refresh_token      String?  @db.Text // リフレッシュトークン: 長期間のログイン維持用
  access_token       String?  @db.Text // アクセストークン: API利用時の一時的な鍵
  
  createdAt          DateTime @default(now()) // 連携日時
  updatedAt          DateTime @updatedAt      // 情報更新日時
  
  @@unique([provider, providerAccountId]) // 同じプロバイダの同じIDは1回しか登録できない (重複ログイン防止)
}

// 認証用トークン（予備/Legacy）
// 現在のFirebase認証フローでは主に使用されませんが、将来的なメール認証拡張などのために保持。
model VerificationToken {
  identifier String   // 識別子: メールアドレスなど
  token      String   @unique // トークン: 一時的な認証コード
  expires    DateTime // 有効期限: この時間を過ぎると無効
  
  @@unique([identifier, token]) // 同じ識別子で同じトークンは重複しない
}

// ユーザーからのフィードバック（ご意見箱）
// 設定画面などから送られた意見を保存します。
model Feedback {
  id        String   @id @default(cuid()) // フィードバックID
  userId    String                        // 送信したユーザーのID
  content   String                        // 意見の内容（テキスト）
  createdAt DateTime @default(now())      // 送信日時
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// --- マネタイズ関連 (サブスク & チケット) ---
// ユーザーの課金状態や、利用回数制限を管理します。

// 料金プランの定義
enum Plan {
  FREE        // フリープラン: 無料、制限きつめ
  STANDARD    // スタンダードプラン: 月額課金、制限緩和
  // STANDARD_TRIAL // スタンダードお試し: 友達紹介などで付与される期間限定の有料級プラン
  PREMIUM     // プレミアムプラン: 最上位、大量に使う人向け
}

// ユーザーのサブスクリプション状況を管理するテーブル
model UserSubscription {
  id            String    @id @default(cuid()) // ID
  userId        String    @unique              // ユーザーID (1ユーザーにつき1レコードのみ)
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // --- 基本プラン設定 ---
  plan          Plan      @default(FREE)       // 現在の契約プラン (デフォルトは無料)
  
  // Stripe連携情報 (決済システムとの紐付け)
  stripeCustomerId       String?   @unique     // Stripeの顧客ID (cus_...): 決済履歴の管理用
  stripeSubscriptionId   String?   @unique     // StripeのサブスクID (sub_...): 定期課金の管理用
  currentPeriodEnd       DateTime?             // サブスク有効期限: これを過ぎると更新または失効
  
  // --- 制限管理 (Quota Management) ---
  
  // 1. チャット制限 (日次/回数)
  // AIとの会話回数をカウントします。
  // Resetルール: FREEは2時間毎、有料プランは毎日リセットされます。
  dailyChatCount    Int       @default(0)       // 今日の(または現在の)チャット送信回数
  lastChatResetAt   DateTime  @default(now())   // 最後にカウントをリセットした日時
  
  // 2. 音声回数制限 (Free専用)
  // 無料ユーザーが「音声アップロード」できる回数。
  dailyVoiceCount   Int       @default(0)       // 今日の音声処理回数
  lastVoiceDate     DateTime  @default(now())   // 最後にリセットした日
  
  // 3. 音声時間制限 (Pro/Premium専用)
  // 有料ユーザーの「月間音声処理可能時間（分）」を管理。
  // 例: スタンダードなら月1800分まで。
  monthlyVoiceMinutes Int     @default(0)       // 今月の利用済み時間(分)
  lastVoiceResetDate  DateTime  @default(now()) // 月次リセット日 (毎月1日にリセットなど)
  
  // 4. 追加購入枠 (チケット残高)
  // プラン上限を超えて使いたい場合に購入した「追加チャージ分」。
  purchasedVoiceBalance Int   @default(0)       // チャージ残高(分): 使うと減っていきます
  
  updatedAt     DateTime  @updatedAt            // データ更新日時
}

// --- 体験版（未ログイン）ユーザー管理 ---
// ログインせずに使っているゲストユーザーの一時データを管理します。
model GuestSession {
  id          String   @id @default(cuid()) // セッションID
  ipAddress   String?  // IPアドレス: 不正利用の防止やレート制限に使用
  createdAt   DateTime @default(now())      // 開始日時
  expiresAt   DateTime // 有効期限: 通常は1時間程度で無効化
  
  // 利用回数制限 (体験版としての制限)
  chatCount   Int      @default(0) // チャット送信数 (例: 上限2回)
  voiceCount  Int      @default(0) // 音声アップロード数 (例: 上限1回)
  
  // 一時データ保管場所
  // ユーザーが体験中に作ったデータを一時保存し、ログイン後に引き継ぐために使います。
  messages    Json[]   @default([]) // チャット履歴の実体 (JSON)
  voiceMemo   String?  // 音声メモの要約結果テキスト
}

// --- 友達招待システム ---
// 「誰が誰を紹介したか」を記録するテーブルです。
model Referral {
  id          String   @id @default(cuid()) // 招待ID
  referrerId  String   // 紹介者ID (招待した人)
  refereeId   String   // 被紹介者ID (招待された人)
  status      String   @default("PENDING") // ステータス: PENDING(招待中), COMPLETED(登録完了), EXPIRED(期限切れ)
  createdAt   DateTime @default(now())      // 招待リンク発行日時
  completedAt DateTime?                     // 登録完了日時
  
  // リレーション
  referrer    User     @relation("SentReferrals", fields: [referrerId], references: [id]) // 紹介者情報
  referee     User     @relation("ReceivedReferral", fields: [refereeId], references: [id]) // 被紹介者情報
  
  @@unique([refereeId]) // 一人のユーザーが「招待される」のは1回限り (重複特典防止)
  @@index([referrerId]) // 紹介者のIDで検索しやすくする (紹介実績のカウント用)
}

model DocumentChunk {
  id         String   @id @default(cuid())
  
  content    String   // Chunk text content
  chunkIndex Int      // Order index within the file
  
  // Metadata matching 
  userId     String
  fileId     String?  // ID from Voice/File metadata (optional)
  fileName   String?
  tags       String[] @default([])
  type       String   // "transcript" or "summary"
  
  // Relation to Document (Postgres)
  documentId String?
  document   Document? @relation(fields: [documentId], references: [id], onDelete: Cascade)

  // Vector data (Gemini uses 768 dimensions)
  embedding  Unsupported("vector(768)")

  createdAt  DateTime @default(now())

  @@index([userId])
  @@index([documentId])
}

